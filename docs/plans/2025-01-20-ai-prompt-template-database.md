# AI Prompt Template Database Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Migrate AI prompt templates from config.json to database, create CRUD API endpoints, and build admin UI for template management.

**Architecture:**
- Add 3 new PostgreSQL tables for hierarchical prompt storage (groups → templates → user preferences)
- RESTful API endpoints following existing `/api/ai-playground` pattern
- React admin UI using existing shadcn/ui components
- Maintain backward compatibility during migration

**Tech Stack:**
- PostgreSQL with Drizzle ORM
- Next.js 16 API routes
- React + TypeScript + Tailwind CSS
- shadcn/ui components (Dialog, Form, Table, etc.)

---

## Task 1: Add Database Schema Tables

**Files:**
- Modify: `src/config/db/schema.postgres.ts` (add after line 788)

**Step 1: Add aiPromptGroup table to schema**

Add to `schema.postgres.ts` after `ai_download_queue` table:

```typescript
// ========================================
// AI Prompt Template Library Tables
// ========================================

export const aiPromptGroup = table(
  'ai_prompt_group',
  {
    id: text('id').primaryKey(),
    userId: text('user_id').references(() => user.id, { onDelete: 'cascade' }),
    name: text('name').notNull(),
    description: text('description'),
    isSystemDefault: boolean('is_system_default').notNull().default(false),
    isActive: boolean('is_active').notNull().default(true),
    createdAt: timestamp('created_at').defaultNow().notNull(),
    updatedAt: timestamp('updated_at')
      .$onUpdate(() => new Date())
      .notNull(),
  },
  (table) => [
    index('idx_ai_prompt_group_user').on(table.userId),
    index('idx_ai_prompt_group_active').on(table.isActive),
  ]
);
```

**Step 2: Add aiPromptTemplateV2 table to schema**

Continue in same file:

```typescript
export const aiPromptTemplateV2 = table(
  'ai_prompt_template_v2',
  {
    id: text('id').primaryKey(),
    promptGroupId: text('prompt_group_id')
      .notNull()
      .references(() => aiPromptGroup.id, { onDelete: 'cascade' }),
    templateKey: text('template_key').notNull(), // 'common_cn', 'main_en', etc.
    templateContent: text('template_content').notNull(),
    language: text('language').notNull(), // 'cn', 'en'
    category: text('category'), // 'common', 'main', 'secondary', 'opt_*'
    createdAt: timestamp('created_at').defaultNow().notNull(),
    updatedAt: timestamp('updated_at')
      .$onUpdate(() => new Date())
      .notNull(),
  },
  (table) => [
    index('idx_ai_prompt_template_v2_group').on(table.promptGroupId),
    index('idx_ai_prompt_template_v2_key').on(table.templateKey),
    uniqueIndex('idx_ai_prompt_template_v2_unique').on(
      table.promptGroupId,
      table.templateKey
    ),
  ]
);
```

**Step 3: Add aiUserPromptPreference table to schema**

Continue in same file:

```typescript
export const aiUserPromptPreference = table(
  'ai_user_prompt_preference',
  {
    id: text('id').primaryKey(),
    userId: text('user_id')
      .notNull()
      .unique()
      .references(() => user.id, { onDelete: 'cascade' }),
    activePromptGroupId: text('active_prompt_group_id').references(
      () => aiPromptGroup.id,
      { onDelete: 'set null' }
    ),
    professionalModeEnabled: boolean('professional_mode_enabled')
      .notNull()
      .default(false),
    useEnglish: boolean('use_english').notNull().default(false),
    defaultTemperature: integer('default_temperature'), // Scaled 0-100
    targetWidth: integer('target_width'),
    targetHeight: integer('target_height'),
    imageFormat: text('image_format').notNull().default('png'),
    quality: integer('quality').notNull().default(90),
    preserveOriginal: boolean('preserve_original').notNull().default(true),
    additionalSettings: jsonb('additional_settings'),
    createdAt: timestamp('created_at').defaultNow().notNull(),
    updatedAt: timestamp('updated_at')
      .$onUpdate(() => new Date())
      .notNull(),
  },
  (table) => [
    index('idx_ai_user_prompt_preference_user').on(table.userId),
  ]
);
```

**Step 4: Export new tables in schema.ts**

Verify the exports at end of file include new tables (already has `export * from './schema.postgres';`)

**Step 5: Commit schema changes**

```bash
git add src/config/db/schema.postgres.ts
git commit -m "feat(ai-prompt): add prompt template library tables to schema"
```

---

## Task 2: Generate and Run Database Migration

**Files:**
- Create: Generated by Drizzle (migration files in `drizzle/`)

**Step 1: Generate migration**

Run from project root:

```bash
npm run db:generate
```

Expected: New migration file created in `drizzle/` with SQL for 3 new tables

**Step 2: Review generated migration**

Check the generated migration file in `drizzle/` directory. Verify it contains:
- CREATE TABLE for `ai_prompt_group`
- CREATE TABLE for `ai_prompt_template_v2`
- CREATE TABLE for `ai_user_prompt_preference`
- All indexes and foreign keys

**Step 3: Push migration to database**

```bash
npm run db:push
```

Expected: "Migration success" or similar confirmation

**Step 4: Verify tables created**

Connect to PostgreSQL and run:

```sql
SELECT table_name FROM information_schema.tables
WHERE table_schema = 'public'
AND table_name LIKE 'ai_prompt%';
```

Expected output:
```
ai_prompt_group
ai_prompt_template_v2
ai_user_prompt_preference
```

**Step 5: Commit migration**

```bash
git add drizzle/
git commit -m "feat(ai-prompt): add database migration for prompt templates"
```

---

## Task 3: Create Database Operations Class

**Files:**
- Modify: `src/lib/db/ai-playground.ts` (add after line 724)

**Step 1: Import new tables**

Add to imports at top of `ai-playground.ts`:

```typescript
import {
  aiJob,
  aiJobLog,
  aiWorkflowState,
  aiImagePair,
  aiPromptTemplate,
  aiUserSetting,
  aiDownloadQueue,
  aiPromptGroup,        // ADD
  aiPromptTemplateV2,   // ADD
  aiUserPromptPreference, // ADD
} from '@/config/db/schema';
```

**Step 2: Add prompt group CRUD methods**

Add at end of `AiPlaygroundDb` class before closing brace:

```typescript
// ========================================
// Prompt Group Operations
// ========================================

/**
 * Create prompt group with templates
 */
async createPromptGroup(input: {
  userId?: string;
  name: string;
  description?: string;
  templates: Array<{ key: string; content: string; language?: string; category?: string }>;
  isSystemDefault?: boolean;
}) {
  const groupId = input.userId ? getUuid() : `g${Date.now()}`;

  const [group] = await db()
    .insert(aiPromptGroup)
    .values({
      id: groupId,
      userId: input.userId || null,
      name: input.name,
      description: input.description || null,
      isSystemDefault: input.isSystemDefault || false,
      isActive: true,
    })
    .returning();

  // Bulk insert templates
  if (input.templates.length > 0) {
    await db()
      .insert(aiPromptTemplateV2)
      .values(
        input.templates.map((template) => ({
          id: getUuid(),
          promptGroupId: groupId,
          templateKey: template.key,
          templateContent: template.content,
          language: template.language || 'cn',
          category: template.category || null,
        }))
      );
  }

  return group;
}

/**
 * Get all prompt groups (user + system defaults)
 */
async getPromptGroups(userId?: string) {
  const userGroups = userId
    ? await db()
        .select()
        .from(aiPromptGroup)
        .where(and(eq(aiPromptGroup.userId, userId), eq(aiPromptGroup.isActive, true)))
    : [];

  const systemGroups = await db()
    .select()
    .from(aiPromptGroup)
    .where(eq(aiPromptGroup.isSystemDefault, true));

  return [...userGroups, ...systemGroups];
}

/**
 * Get single prompt group with all templates
 */
async getPromptGroupWithTemplates(groupId: string) {
  const [group] = await db()
    .select()
    .from(aiPromptGroup)
    .where(eq(aiPromptGroup.id, groupId))
    .limit(1);

  if (!group) return null;

  const templates = await db()
    .select()
    .from(aiPromptTemplateV2)
    .where(eq(aiPromptTemplateV2.promptGroupId, groupId));

  const promptTemplates: Record<string, string> = {};
  for (const template of templates) {
    promptTemplates[template.templateKey as any] = template.templateContent;
  }

  return {
    ...group,
    prompt_templates: promptTemplates,
  };
}

/**
 * Update prompt group
 */
async updatePromptGroup(
  groupId: string,
  updates: {
    name?: string;
    description?: string;
    isActive?: boolean;
  }
) {
  const [group] = await db()
    .update(aiPromptGroup)
    .set({
      ...updates,
      updatedAt: new Date(),
    })
    .where(eq(aiPromptGroup.id, groupId))
    .returning();

  return group;
}

/**
 * Delete prompt group (soft delete)
 */
async deletePromptGroup(groupId: string) {
  const [group] = await db()
    .update(aiPromptGroup)
    .set({ isActive: false, updatedAt: new Date() })
    .where(eq(aiPromptGroup.id, groupId))
    .returning();

  return group;
}

// ========================================
// Prompt Template Operations
// ========================================

/**
 * Update template in a group
 */
async updatePromptTemplate(
  templateId: string,
  updates: {
    templateContent?: string;
    category?: string;
  }
) {
  const [template] = await db()
    .update(aiPromptTemplateV2)
    .set({
      ...updates,
      updatedAt: new Date(),
    })
    .where(eq(aiPromptTemplateV2.id, templateId))
    .returning();

  return template;
}

// ========================================
// User Prompt Preference Operations
// ========================================

/**
 * Get or create user prompt preferences
 */
async getUserPromptPreferences(userId: string) {
  let [prefs] = await db()
    .select()
    .from(aiUserPromptPreference)
    .where(eq(aiUserPromptPreference.userId, userId))
    .limit(1);

  if (!prefs) {
    [prefs] = await db()
      .insert(aiUserPromptPreference)
      .values({
        id: getUuid(),
        userId,
        professionalModeEnabled: false,
        useEnglish: false,
        imageFormat: 'png',
        quality: 90,
        preserveOriginal: true,
      })
      .returning();
  }

  return prefs;
}

/**
 * Update user prompt preferences
 */
async updateUserPromptPreferences(
  userId: string,
  updates: {
    activePromptGroupId?: string;
    professionalModeEnabled?: boolean;
    useEnglish?: boolean;
    defaultTemperature?: number;
    targetWidth?: number;
    targetHeight?: number;
    imageFormat?: string;
    quality?: number;
    preserveOriginal?: boolean;
  }
) {
  const [prefs] = await db()
    .update(aiUserPromptPreference)
    .set({
      ...updates,
      updatedAt: new Date(),
    })
    .where(eq(aiUserPromptPreference.userId, userId))
    .returning();

  return prefs;
}
```

**Step 3: Commit database operations**

```bash
git add src/lib/db/ai-playground.ts
git commit -m "feat(ai-prompt): add prompt template database operations"
```

---

## Task 4: Create API Route - List Prompt Groups

**Files:**
- Create: `src/app/api/ai-playground/prompt-groups/route.ts`

**Step 1: Create GET endpoint**

```typescript
import { respData, respErr } from '@/shared/lib/resp';
import { getUserInfo } from '@/shared/models/user';
import { aiPlaygroundDb } from '@/lib/db/ai-playground';

// GET /api/ai-playground/prompt-groups - List all prompt groups
export async function GET(req: Request) {
  try {
    const user = await getUserInfo();
    if (!user) {
      return respErr('Unauthorized, please sign in');
    }

    const groups = await aiPlaygroundDb.getPromptGroups(user.id);
    return respData({ groups });
  } catch (error) {
    console.error('Get prompt groups error:', error);
    return respErr('Failed to load prompt groups');
  }
}
```

**Step 2: Test endpoint**

Run:
```bash
curl -X GET http://localhost:3000/api/ai-playground/prompt-groups \
  -H "Cookie: <your-auth-cookie>"
```

Expected: `{"code":0,"data":{"groups":[]}}` (empty initially)

**Step 3: Commit**

```bash
git add src/app/api/ai-playground/prompt-groups/route.ts
git commit -m "feat(ai-prompt): add GET /prompt-groups endpoint"
```

---

## Task 5: Create API Route - Create Prompt Group

**Files:**
- Modify: `src/app/api/ai-playground/prompt-groups/route.ts`

**Step 1: Add POST endpoint**

Add after GET function:

```typescript
// POST /api/ai-playground/prompt-groups - Create new prompt group
export async function POST(req: Request) {
  try {
    const user = await getUserInfo();
    if (!user) {
      return respErr('Unauthorized, please sign in');
    }

    const body = await req.json();
    const { name, description, templates, isSystemDefault } = body;

    if (!name || typeof name !== 'string') {
      return respErr('Name is required');
    }

    if (!Array.isArray(templates)) {
      return respErr('Templates must be an array');
    }

    // Admin-only for system defaults
    if (isSystemDefault) {
      // TODO: Add admin check
      return respErr('Only admins can create system defaults');
    }

    const group = await aiPlaygroundDb.createPromptGroup({
      userId: user.id,
      name,
      description,
      templates: templates.map((t: any) => ({
        key: t.key,
        content: t.content,
        language: t.language || 'cn',
        category: t.category || null,
      })),
      isSystemDefault: false,
    });

    return respData({ group });
  } catch (error) {
    console.error('Create prompt group error:', error);
    return respErr('Failed to create prompt group');
  }
}
```

**Step 2: Test endpoint**

Run:
```bash
curl -X POST http://localhost:3000/api/ai-playground/prompt-groups \
  -H "Content-Type: application/json" \
  -H "Cookie: <your-auth-cookie>" \
  -d '{
    "name": "测试提示词组",
    "description": "用于测试的提示词",
    "templates": [
      {
        "key": "common_cn",
        "content": "你是一个AI助手",
        "language": "cn",
        "category": "common"
      }
    ]
  }'
```

Expected: `{"code":0,"data":{"group":{...}}}`

**Step 3: Commit**

```bash
git add src/app/api/ai-playground/prompt-groups/route.ts
git commit -m "feat(ai-prompt): add POST /prompt-groups endpoint"
```

---

## Task 6: Create API Route - Get Single Prompt Group

**Files:**
- Create: `src/app/api/ai-playground/prompt-groups/[id]/route.ts`

**Step 1: Create dynamic route handler**

```typescript
import { respData, respErr } from '@/shared/lib/resp';
import { getUserInfo } from '@/shared/models/user';
import { aiPlaygroundDb } from '@/lib/db/ai-playground';

// GET /api/ai-playground/prompt-groups/[id] - Get single group with templates
export async function GET(
  req: Request,
  { params }: { params: { id: string } }
) {
  try {
    const user = await getUserInfo();
    if (!user) {
      return respErr('Unauthorized, please sign in');
    }

    const group = await aiPlaygroundDb.getPromptGroupWithTemplates(params.id);

    if (!group) {
      return respErr('Prompt group not found');
    }

    return respData({ group });
  } catch (error) {
    console.error('Get prompt group error:', error);
    return respErr('Failed to load prompt group');
  }
}

// PATCH /api/ai-playground/prompt-groups/[id] - Update group
export async function PATCH(
  req: Request,
  { params }: { params: { id: string } }
) {
  try {
    const user = await getUserInfo();
    if (!user) {
      return respErr('Unauthorized, please sign in');
    }

    const body = await req.json();
    const { name, description, isActive } = body;

    const group = await aiPlaygroundDb.updatePromptGroup(params.id, {
      name,
      description,
      isActive,
    });

    return respData({ group });
  } catch (error) {
    console.error('Update prompt group error:', error);
    return respErr('Failed to update prompt group');
  }
}

// DELETE /api/ai-playground/prompt-groups/[id] - Soft delete group
export async function DELETE(
  req: Request,
  { params }: { params: { id: string } }
) {
  try {
    const user = await getUserInfo();
    if (!user) {
      return respErr('Unauthorized, please sign in');
    }

    const group = await aiPlaygroundDb.deletePromptGroup(params.id);

    return respData({ group });
  } catch (error) {
    console.error('Delete prompt group error:', error);
    return respErr('Failed to delete prompt group');
  }
}
```

**Step 2: Test GET endpoint**

Run:
```bash
curl -X GET http://localhost:3000/api/ai-playground/prompt-groups/<id-from-step-5> \
  -H "Cookie: <your-auth-cookie>"
```

Expected: Response with `prompt_templates` object containing all template keys

**Step 3: Commit**

```bash
git add src/app/api/ai-playground/prompt-groups/[id]/route.ts
git commit -m "feat(ai-prompt): add prompt group detail endpoints"
```

---

## Task 7: Create API Route - User Preferences

**Files:**
- Create: `src/app/api/ai-playground/prompt-preferences/route.ts`

**Step 1: Create GET/POST endpoint**

```typescript
import { respData, respErr } from '@/shared/lib/resp';
import { getUserInfo } from '@/shared/models/user';
import { aiPlaygroundDb } from '@/lib/db/ai-playground';

// GET /api/ai-playground/prompt-preferences - Get user preferences
export async function GET(req: Request) {
  try {
    const user = await getUserInfo();
    if (!user) {
      return respErr('Unauthorized, please sign in');
    }

    const prefs = await aiPlaygroundDb.getUserPromptPreferences(user.id);
    return respData({ preferences: prefs });
  } catch (error) {
    console.error('Get prompt preferences error:', error);
    return respErr('Failed to load preferences');
  }
}

// PATCH /api/ai-playground/prompt-preferences - Update user preferences
export async function PATCH(req: Request) {
  try {
    const user = await getUserInfo();
    if (!user) {
      return respErr('Unauthorized, please sign in');
    }

    const body = await req.json();
    const {
      activePromptGroupId,
      professionalModeEnabled,
      useEnglish,
      defaultTemperature,
      targetWidth,
      targetHeight,
      imageFormat,
      quality,
      preserveOriginal,
    } = body;

    const prefs = await aiPlaygroundDb.updateUserPromptPreferences(
      user.id,
      {
        activePromptGroupId,
        professionalModeEnabled,
        useEnglish,
        defaultTemperature,
        targetWidth,
        targetHeight,
        imageFormat,
        quality,
        preserveOriginal,
      }
    );

    return respData({ preferences: prefs });
  } catch (error) {
    console.error('Update prompt preferences error:', error);
    return respErr('Failed to update preferences');
  }
}
```

**Step 2: Test GET endpoint**

Run:
```bash
curl -X GET http://localhost:3000/api/ai-playground/prompt-preferences \
  -H "Cookie: <your-auth-cookie>"
```

Expected: `{"code":0,"data":{"preferences":{...}}}`

**Step 3: Test PATCH endpoint**

Run:
```bash
curl -X PATCH http://localhost:3000/api/ai-playground/prompt-preferences \
  -H "Content-Type: application/json" \
  -H "Cookie: <your-auth-cookie>" \
  -d '{"useEnglish": true}'
```

Expected: Updated preferences with `useEnglish: true`

**Step 4: Commit**

```bash
git add src/app/api/ai-playground/prompt-preferences/route.ts
git commit -m "feat(ai-prompt): add user preferences endpoints"
```

---

## Task 8: Create Admin - Prompt Groups List Page

**Files:**
- Create: `src/app/[locale]/(user)/dashboard/admin/prompt-groups/page.tsx`

**Step 1: Create page component**

```typescript
'use client';

import { useEffect, useState } from 'react';
import { Button } from '@/shared/components/ui/button';
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/shared/components/ui/table';
import { Badge } from '@/shared/components/ui/badge';
import { Plus, Edit, Trash2 } from 'lucide-react';

interface PromptGroup {
  id: string;
  name: string;
  description: string | null;
  isSystemDefault: boolean;
  createdAt: string;
}

export default function PromptGroupsPage() {
  const [groups, setGroups] = useState<PromptGroup[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchGroups();
  }, []);

  const fetchGroups = async () => {
    try {
      const res = await fetch('/api/ai-playground/prompt-groups');
      const data = await res.json();
      if (data.code === 0) {
        setGroups(data.data.groups);
      }
    } catch (error) {
      console.error('Failed to fetch groups:', error);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="container mx-auto py-6">
      <div className="mb-6 flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold">AI Prompt Templates</h1>
          <p className="text-sm text-gray-600">
            Manage prompt template groups
          </p>
        </div>
        <Button>
          <Plus className="mr-2 h-4 w-4" />
          New Group
        </Button>
      </div>

      <div className="rounded-md border">
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead>Name</TableHead>
              <TableHead>Description</TableHead>
              <TableHead>Type</TableHead>
              <TableHead>Created</TableHead>
              <TableHead>Actions</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {loading ? (
              <TableRow>
                <TableCell colSpan={5} className="text-center">
                  Loading...
                </TableCell>
              </TableRow>
            ) : groups.length === 0 ? (
              <TableRow>
                <TableCell colSpan={5} className="text-center">
                  No prompt groups found
                </TableCell>
              </TableRow>
            ) : (
              groups.map((group) => (
                <TableRow key={group.id}>
                  <TableCell className="font-medium">{group.name}</TableCell>
                  <TableCell>{group.description || '-'}</TableCell>
                  <TableCell>
                    {group.isSystemDefault ? (
                      <Badge>System</Badge>
                    ) : (
                      <Badge variant="outline">User</Badge>
                    )}
                  </TableCell>
                  <TableCell>
                    {new Date(group.createdAt).toLocaleDateString()}
                  </TableCell>
                  <TableCell>
                    <div className="flex gap-2">
                      <Button size="sm" variant="ghost">
                        <Edit className="h-4 w-4" />
                      </Button>
                      <Button size="sm" variant="ghost">
                        <Trash2 className="h-4 w-4" />
                      </Button>
                    </div>
                  </TableCell>
                </TableRow>
              ))
            )}
          </TableBody>
        </Table>
      </div>
    </div>
  );
}
```

**Step 2: Visit the page**

Navigate to: `/dashboard/admin/prompt-groups`

Expected: Table showing prompt groups (empty initially)

**Step 3: Commit**

```bash
git add src/app/[locale]/(user)/dashboard/admin/prompt-groups/
git commit -m "feat(ai-prompt): add prompt groups list page"
```

---

## Task 9: Create Admin - Create/Edit Prompt Group Dialog

**Files:**
- Modify: `src/app/[locale]/(user)/dashboard/admin/prompt-groups/page.tsx`

**Step 1: Add dialog component**

Add to same file, before page component:

```typescript
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from '@/shared/components/ui/dialog';
import { Input } from '@/shared/components/ui/input';
import { Label } from '@/shared/components/ui/label';
import { Textarea } from '@/shared/components/ui/textarea';

interface PromptTemplate {
  key: string;
  content: string;
  language: string;
  category: string;
}

function PromptGroupDialog({
  open,
  onClose,
  group,
}: {
  open: boolean;
  onClose: () => void;
  group: any;
}) {
  const [name, setName] = useState(group?.name || '');
  const [description, setDescription] = useState(group?.description || '');
  const [templates, setTemplates] = useState<PromptTemplate[]>(
    group?.prompt_templates
      ? Object.entries(group.prompt_templates).map(([key, content]) => ({
          key,
          content: content as string,
          language: key.endsWith('_cn') ? 'cn' : 'en',
          category: key.startsWith('opt_') ? 'option' : 'main',
        }))
      : []
  );
  const [saving, setSaving] = useState(false);

  const handleSave = async () => {
    setSaving(true);
    try {
      const method = group ? 'PATCH' : 'POST';
      const url = group
        ? `/api/ai-playground/prompt-groups/${group.id}`
        : '/api/ai-playground/prompt-groups';

      const res = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name,
          description,
          templates,
        }),
      });

      if (res.ok) {
        onClose();
        window.location.reload();
      }
    } catch (error) {
      console.error('Failed to save:', error);
    } finally {
      setSaving(false);
    }
  };

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent className="max-w-2xl max-h-[80vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle>
            {group ? 'Edit Prompt Group' : 'New Prompt Group'}
          </DialogTitle>
        </DialogHeader>

        <div className="space-y-4 py-4">
          <div>
            <Label htmlFor="name">Name</Label>
            <Input
              id="name"
              value={name}
              onChange={(e) => setName(e.target.value)}
              placeholder="e.g., 默认提示词"
            />
          </div>

          <div>
            <Label htmlFor="description">Description</Label>
            <Textarea
              id="description"
              value={description}
              onChange={(e) => setDescription(e.target.value)}
              placeholder="Optional description"
              rows={2}
            />
          </div>

          <div>
            <Label>Templates</Label>
            <div className="mt-2 space-y-2">
              {templates.map((template, index) => (
                <div key={index} className="border rounded p-3 space-y-2">
                  <div className="flex gap-2">
                    <Input
                      value={template.key}
                      onChange={(e) => {
                        const newTemplates = [...templates];
                        newTemplates[index].key = e.target.value;
                        setTemplates(newTemplates);
                      }}
                      placeholder="Template key (e.g., common_cn)"
                      className="flex-1"
                    />
                    <Button
                      size="sm"
                      variant="outline"
                      onClick={() => {
                        setTemplates(templates.filter((_, i) => i !== index));
                      }}
                    >
                      Remove
                    </Button>
                  </div>
                  <Textarea
                    value={template.content}
                    onChange={(e) => {
                      const newTemplates = [...templates];
                      newTemplates[index].content = e.target.value;
                      setTemplates(newTemplates);
                    }}
                    placeholder="Template content..."
                    rows={4}
                  />
                </div>
              ))}
              <Button
                variant="outline"
                className="w-full"
                onClick={() => {
                  setTemplates([
                    ...templates,
                    { key: '', content: '', language: 'cn', category: 'main' },
                  ]);
                }}
              >
                Add Template
              </Button>
            </div>
          </div>
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={onClose}>
            Cancel
          </Button>
          <Button onClick={handleSave} disabled={saving || !name}>
            {saving ? 'Saving...' : 'Save'}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```

**Step 2: Integrate dialog with page**

Update page component:

```typescript
export default function PromptGroupsPage() {
  // ... existing state ...

  const [dialogOpen, setDialogOpen] = useState(false);
  const [selectedGroup, setSelectedGroup] = useState<any>(null);

  // ... existing useEffect ...

  const handleEdit = (group: PromptGroup) => {
    // Fetch full group details
    fetch(`/api/ai-playground/prompt-groups/${group.id}`)
      .then((res) => res.json())
      .then((data) => {
        if (data.code === 0) {
          setSelectedGroup(data.data.group);
          setDialogOpen(true);
        }
      });
  };

  return (
    <div className="container mx-auto py-6">
      {/* ... existing header ... */}

      {/* ... existing table ... */}
                  <TableCell>
                    <div className="flex gap-2">
                      <Button
                        size="sm"
                        variant="ghost"
                        onClick={() => handleEdit(group)}
                      >
                        <Edit className="h-4 w-4" />
                      </Button>
                      {/* ... delete button ... */}
                    </div>
                  </TableCell>

      {/* Add dialog at end */}
      <PromptGroupDialog
        open={dialogOpen}
        onClose={() => {
          setDialogOpen(false);
          setSelectedGroup(null);
        }}
        group={selectedGroup}
      />
    </div>
  );
}
```

**Step 3: Test create functionality**

1. Click "New Group" button
2. Enter name: "Test Group"
3. Add template with key: `test_cn` and content: "Test prompt"
4. Click Save

Expected: New group appears in table

**Step 4: Commit**

```bash
git add src/app/[locale]/(user)/dashboard/admin/prompt-groups/page.tsx
git commit -m "feat(ai-prompt): add create/edit prompt group dialog"
```

---

## Task 10: Add Delete Confirmation

**Files:**
- Modify: `src/app/[locale]/(user)/dashboard/admin/prompt-groups/page.tsx`

**Step 1: Add delete handler**

Add to page component:

```typescript
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from '@/shared/components/ui/alert-dialog';

export default function PromptGroupsPage() {
  // ... existing state ...

  const [deleteDialogOpen, setDeleteDialogOpen] = useState(false);
  const [groupToDelete, setGroupToDelete] = useState<string | null>(null);

  const handleDelete = async (groupId: string) => {
    setGroupToDelete(groupId);
    setDeleteDialogOpen(true);
  };

  const confirmDelete = async () => {
    if (!groupToDelete) return;

    try {
      const res = await fetch(`/api/ai-playground/prompt-groups/${groupToDelete}`, {
        method: 'DELETE',
      });

      if (res.ok) {
        setDeleteDialogOpen(false);
        setGroupToDelete(null);
        fetchGroups(); // Refresh list
      }
    } catch (error) {
      console.error('Failed to delete:', error);
    }
  };

  return (
    <div className="container mx-auto py-6">
      {/* ... existing content ... */}

      <AlertDialog open={deleteDialogOpen} onOpenChange={setDeleteDialogOpen}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>Delete Prompt Group</AlertDialogTitle>
            <AlertDialogDescription>
              Are you sure you want to delete this prompt group? This action cannot be undone.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel>Cancel</AlertDialogCancel>
            <AlertDialogAction onClick={confirmDelete}>
              Delete
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </div>
  );
}
```

**Step 2: Update delete button**

Update the delete button in table:

```typescript
<Button
  size="sm"
  variant="ghost"
  onClick={() => handleDelete(group.id)}
>
  <Trash2 className="h-4 w-4" />
</Button>
```

**Step 3: Test delete**

1. Click delete button on a group
2. Confirm in dialog

Expected: Group removed from table

**Step 4: Commit**

```bash
git add src/app/[locale]/(user)/dashboard/admin/prompt-groups/page.tsx
git commit -m "feat(ai-prompt): add delete confirmation dialog"
```

---

## Task 11: Seed Initial Prompt Groups from Config

**Files:**
- Create: `scripts/seed-prompt-groups.ts`

**Step 1: Create seed script**

```typescript
import { aiPlaygroundDb } from '../src/lib/db/ai-playground';
import { readFileSync } from 'fs';

// Read config.json
const configPath = './dev/ozon-backen/demo2/config.json';
const config = JSON.parse(readFileSync(configPath, 'utf-8'));

async function seedPromptGroups() {
  console.log('Seeding prompt groups...');

  for (const group of config.prompt_groups) {
    console.log(`Creating group: ${group.name}`);

    // Convert templates object to array
    const templates = Object.entries(group.prompt_templates).map(
      ([key, content]) => ({
        key,
        content: content as string,
        language: key.endsWith('_cn') ? 'cn' : 'en',
        category: key.startsWith('opt_')
          ? 'option'
          : key.startsWith('main')
          ? 'main'
          : key.startsWith('secondary')
          ? 'secondary'
          : 'common',
      })
    );

    await aiPlaygroundDb.createPromptGroup({
      userId: undefined, // System default (no user)
      name: group.name,
      description: `Imported from config.json`,
      templates,
      isSystemDefault: true,
    });
  }

  console.log('Seeding complete!');
}

seedPromptGroups().catch(console.error);
```

**Step 2: Run seed script**

```bash
npx tsx scripts/seed-prompt-groups.ts
```

Expected: Console output showing groups being created

**Step 3: Verify in database**

```bash
curl -X GET http://localhost:3000/api/ai-playground/prompt-groups \
  -H "Cookie: <your-auth-cookie>"
```

Expected: Response with multiple prompt groups

**Step 4: Commit**

```bash
git add scripts/seed-prompt-groups.ts
git commit -m "feat(ai-prompt): add script to seed prompt groups from config"
```

---

## Task 12: Update ImageStudio to Use Database Prompts

**Files:**
- Modify: `src/lib/api/image-studio.ts`
- Modify: `src/shared/contexts/image-studio.tsx`

**Step 1: Add function to fetch active prompt group**

Add to `image-studio.ts`:

```typescript
/**
 * Get user's active prompt group
 */
export async function getActivePromptGroup(): Promise<any> {
  const response = await fetch(`${API_BASE}/prompt-preferences`);
  const data = await handleResponse<{ preferences: any }>(response);

  if (data.preferences.activePromptGroupId) {
    const groupRes = await fetch(
      `${API_BASE}/prompt-groups/${data.preferences.activePromptGroupId}`
    );
    const groupData = await handleResponse<{ group: any }>(groupRes);
    return groupData.group;
  }

  return null;
}
```

**Step 2: Update context to load prompts**

Update `image-studio.tsx` useEffect:

```typescript
useEffect(() => {
  api.getSettings().then(setSettings).catch(console.error);
  loadBatchStats();
  loadSKUs();

  // Load active prompt group
  api.getActivePromptGroup()
    .then(setActivePromptGroup)
    .catch(console.error);
}, []);
```

**Step 3: Add state for prompt group**

Add to context state:

```typescript
const [activePromptGroup, setActivePromptGroup] = useState<any>(null);
```

Add to context value:

```typescript
activePromptGroup,
```

**Step 4: Commit**

```bash
git add src/lib/api/image-studio.ts src/shared/contexts/image-studio.tsx
git commit -m "feat(ai-prompt): integrate database prompts with ImageStudio"
```

---

## Summary

This implementation plan:

1. ✅ Adds 3 new database tables for hierarchical prompt storage
2. ✅ Creates full CRUD API endpoints for prompt groups and user preferences
3. ✅ Builds admin UI for managing prompt templates
4. ✅ Seeds existing prompts from config.json
5. ✅ Integrates database prompts with ImageStudio

**Total commits**: 12
**Estimated time**: 4-6 hours

**Next steps after implementation:**
- Add admin role checks to prevent unauthorized access
- Add template versioning for A/B testing
- Add import/export functionality for prompt groups
- Monitor performance and add caching if needed
